#!/bin/bash
set -e

# Создаем пользователя sql, если не существует
if ! id "sql" &>/dev/null; then
    useradd -r -s /bin/false sql
fi

# Создаем пользователя mssql, если не существует (для монтирования)
if ! id "mssql" &>/dev/null; then
    useradd -r -s /bin/false mssql
fi

# Создаем директории, если не существуют
mkdir -p /var/log/sqlmanager
mkdir -p /mnt/sql_backups
mkdir -p /etc/smbcredentials

# Устанавливаем права на директории и файлы
chown -R sql:sql /opt/SQLManager
chown -R sql:sql /var/log/sqlmanager
chmod -R 750 /opt/SQLManager
chmod -R 750 /var/log/sqlmanager

# Копируем конфигурационный файл, если не существует
if [ ! -f /etc/sqlmanager/config.yaml ]; then
    mkdir -p /etc/sqlmanager
    cp /opt/SQLManager/config.yaml /etc/sqlmanager/config.yaml
    chown sql:sql /etc/sqlmanager/config.yaml
    chmod 600 /etc/sqlmanager/config.yaml
fi

# Копируем файл монтирования, если не существует
if [ ! -f /etc/systemd/system/mnt-sql_backups.mount ]; then
    cp /opt/SQLManager/mnt-sql_backups.mount /etc/systemd/system/
    systemctl enable mnt-sql_backups.mount || true
fi

# Перезагружаем systemd
systemctl daemon-reload || true

# Включаем и запускаем сервисы
systemctl enable sqlmanager.service || true
systemctl start sqlmanager.service || true

echo "SQLManager установлен. Пожалуйста, настройте /etc/sqlmanager/config.yaml и /etc/smbcredentials/.veeamsrv_creds перед использованием."
